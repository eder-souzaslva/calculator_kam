<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Plano de A√ß√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #4D00AE 0%, #222222 100%);
            color: #222222;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FFFFFF;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #4D00AE 0%, #7740F9 100%);
            color: #FFFFFF;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            font-weight: 300;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: linear-gradient(135deg, #7740F9 0%, #13AAE6 100%);
            color: #FFFFFF;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            background: #F8F9FA;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #7740F9;
        }
        
        .input-group label {
            display: block;
            color: #4D00AE;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #DDDDDD;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1em;
            transition: border 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #7740F9;
        }
        
        .input-group input[type="number"] {
            text-align: right;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #4D00AE 0%, #7740F9 100%);
            color: #FFFFFF;
            border: none;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(77,0,174,0.3);
            display: block;
            margin: 30px auto;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(77,0,174,0.4);
        }
        
        .results-section {
            display: none;
            margin-top: 40px;
        }
        
        .results-section.active {
            display: block;
        }
        
        .result-card {
            background: linear-gradient(135deg, #D5BFF1 0%, #FFFFFF 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #4D00AE;
        }
        
        .result-title {
            color: #4D00AE;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .result-value {
            color: #7740F9;
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .funnel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .funnel-table thead {
            background: linear-gradient(135deg, #4D00AE 0%, #7740F9 100%);
            color: #FFFFFF;
        }
        
        .funnel-table th {
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }
        
        .funnel-table td {
            padding: 15px 18px;
            border-bottom: 1px solid #DDDDDD;
        }
        
        .funnel-table tbody tr:hover {
            background: #D5BFF1;
            transition: background 0.3s ease;
        }
        
        .funnel-table .step-number {
            background: #7740F9;
            color: #FFFFFF;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .funnel-table .metric-name {
            font-weight: 600;
            color: #4D00AE;
        }
        
        .funnel-table .metric-value {
            font-weight: 700;
            color: #7740F9;
            font-size: 1.1em;
        }
        
        .highlight-row {
            background: #13AAE6 !important;
            color: #FFFFFF !important;
        }
        
        .highlight-row td {
            color: #FFFFFF !important;
            font-weight: 700 !important;
        }
        
        .warning-box {
            background: #DDDDDD;
            border-left: 5px solid #7740F9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success-box {
            background: #E8F5E9;
            border-left: 5px solid #4CAF50;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #2E7D32;
            font-weight: 600;
        }
        
        .config-box {
            background: #222222;
            color: #FFFFFF;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .config-box h3 {
            color: #13AAE6;
            margin-bottom: 15px;
        }
        
        .config-item {
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-label {
            color: #D5BFF1;
            font-weight: 600;
        }
        
        .config-value {
            color: #13AAE6;
            font-weight: 700;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Calculadora de Plano de A√ß√£o</h1>
            <p>Sistema de c√°lculo para planejamento estrat√©gico de contas novas</p>
        </div>
        
        <div class="content">
            <!-- Dados do Cliente -->
            <div class="section">
                <div class="section-title">üìã Dados do Cliente</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Nome do Cliente</label>
                        <input type="text" id="clientName" placeholder="Ex: Banco Nova Era">
                    </div>
                    <div class="input-group">
                        <label>Base de CPF Ativa</label>
                        <input type="number" id="baseSize" placeholder="Ex: 52182">
                    </div>
                    <div class="input-group">
                        <label>Atendimentos Contratados (M√≠nimo Garantido)</label>
                        <input type="number" id="minAttendance" placeholder="Ex: 10000">
                    </div>
                </div>
            </div>
            
            <!-- Dados Comerciais -->
            <div class="section">
                <div class="section-title">üí∞ Dados Comerciais</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Valor por Atendimento (R$)</label>
                        <input type="number" step="0.01" id="valuePerAttendance" placeholder="Ex: 1.79">
                    </div>
                    <div class="input-group">
                        <label>Licen√ßa da Plataforma (R$)</label>
                        <input type="number" step="0.01" id="platformLicense" placeholder="Ex: 2985.00">
                    </div>
                    <div class="input-group">
                        <label>ROI Objetivo (multiplicador)</label>
                        <input type="number" step="0.1" id="targetROI" placeholder="Ex: 15" min="2">
                        <div style="color: #FF9800; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            M√≠nimo recomendado: 15x
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dados do Funil -->
            <div class="section">
                <div class="section-title">üìä Dados do Funil (%)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Taxa de Entrega WhatsApp (%)</label>
                        <input type="number" step="0.1" id="deliveryRate" value="95" placeholder="Ex: 95">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Taxa de Resposta (%)</label>
                        <input type="number" step="0.1" id="responseRate" value="20" placeholder="Ex: 20">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Taxa de CPC (%)</label>
                        <input type="number" step="0.1" id="cpcRate" value="56" placeholder="Ex: 56">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Taxa de Convers√£o (%)</label>
                        <input type="number" step="0.1" id="conversionRate" value="23" placeholder="Ex: 23">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Efetividade de Pagamento (%)</label>
                        <input type="number" step="0.1" id="paymentRate" value="40" placeholder="Ex: 40">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para usar taxa recomendada
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Ticket M√©dio (R$)</label>
                        <input type="number" step="0.01" id="avgTicket" placeholder="Ex: 285.00 ou deixe vazio">
                        <div style="color: #13AAE6; font-size: 0.85em; margin-top: 5px; font-style: italic;">
                            Deixe vazio para calcular automaticamente
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dados Temporais -->
            <div class="section">
                <div class="section-title">üìÖ Dados Temporais</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Dias √öteis do M√™s</label>
                        <input type="number" id="workDays" value="21" placeholder="Ex: 21" min="1" max="31">
                    </div>
                    <div class="input-group">
                        <label>Prazo de Vencimento (dias)</label>
                        <input type="number" id="paymentDeadline" value="3" placeholder="Ex: 3" min="0">
                    </div>
                </div>
            </div>
            
            <button class="calculate-btn" onclick="calculate()">üöÄ CALCULAR PLANO DE A√á√ÉO</button>
            
            <!-- Resultados -->
            <div class="results-section" id="results">
                <div class="section-title">üìà Resultados do Plano de A√ß√£o</div>
                
                <!-- An√°lise de Cen√°rios -->
                <div id="scenarioAnalysis"></div>
                
                <!-- Investimento e ROI -->
                <div class="result-card">
                    <div class="result-title">üíµ An√°lise Financeira</div>
                    <!-- Primeira Linha -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #D5BFF1;">
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Investimento Final</div>
                            <div class="result-value" id="finalInvestment">-</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Investimento MIA</div>
                            <div class="result-value" id="totalInvestment">-</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Custo HSM</div>
                            <div class="result-value" id="hsmCost">-</div>
                        </div>
                    </div>
                    <!-- Segunda Linha -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Valor a Recuperar</div>
                            <div class="result-value" id="targetRecovery">-</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">ROI</div>
                            <div class="result-value" id="roiDisplay">-</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9em;">Custo Operacional</div>
                            <div class="result-value" id="operationalCost">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Funil Reverso -->
                <table class="funnel-table">
                    <thead>
                        <tr>
                            <th>Etapa</th>
                            <th>M√©trica</th>
                            <th>Valor</th>
                            <th>Taxa/C√°lculo</th>
                        </tr>
                    </thead>
                    <tbody id="funnelTableBody">
                    </tbody>
                </table>
                
                <!-- Configura√ß√µes Operacionais -->
                <div class="config-box">
                    <h3>‚öôÔ∏è Configura√ß√µes Operacionais</h3>
                    <div class="config-item">
                        <span class="config-label">Disparos por dia:</span>
                        <span class="config-value" id="dailyDispatches">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Espa√ßamento entre disparos:</span>
                        <span class="config-value" id="dispatchSpacing">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Penetra√ß√£o de base:</span>
                        <span class="config-value" id="basePenetration">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Dias √∫teis produtivos:</span>
                        <span class="config-value" id="productiveDays">-</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">Capacidade total da base:</span>
                        <span class="config-value" id="baseCapacity">-</span>
                    </div>
                </div>
                
                <div id="alertMessages"></div>
                
                <!-- Bot√£o de Download PDF -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="calculate-btn" onclick="downloadPDF()" style="background: linear-gradient(135deg, #13AAE6 0%, #4D00AE 100%);">
                        üìÑ BAIXAR PLANO DE A√á√ÉO
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function formatNumber(value) {
            return new Intl.NumberFormat('pt-BR').format(Math.round(value));
        }
        
        function formatPercent(value) {
            return value.toFixed(1) + '%';
        }
        
        function formatROI(value) {
            let roiPercent = value * 100;
            
            // Se ROI >= 100%, arredonda sem casas decimais
            if (roiPercent >= 100) {
                return Math.round(roiPercent) + '%';
            }
            
            // Se ROI < 100%, usa at√© 4 casas decimais sem zeros desnecess√°rios
            roiPercent = roiPercent.toFixed(4);
            roiPercent = parseFloat(roiPercent).toString();
            return roiPercent + '%';
        }
        
        function calculate() {
            const baseSize = parseFloat(document.getElementById('baseSize').value);
            const minAttendance = parseFloat(document.getElementById('minAttendance').value);
            const valuePerAttendance = parseFloat(document.getElementById('valuePerAttendance').value);
            const platformLicense = parseFloat(document.getElementById('platformLicense').value) || 0;
            let targetROI = parseFloat(document.getElementById('targetROI').value);
            
            if (isNaN(targetROI) || targetROI <= 0) {
                targetROI = 15;
                document.getElementById('targetROI').value = 15;
            }
            
            if (isNaN(baseSize) || isNaN(minAttendance) || isNaN(valuePerAttendance)) {
                alert('Por favor, preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            // VALIDA√á√ÉO: Base insuficiente (atendimentos > 4x base)
            if (minAttendance > (baseSize * 4)) {
                alert('üö® BASE INSUFICIENTE!\n\nO volume de atendimentos contratados (' + formatNumber(minAttendance) + ') √© maior que 4x a base dispon√≠vel (' + formatNumber(baseSize * 4) + ').\n\nN√£o √© poss√≠vel realizar o c√°lculo com essa configura√ß√£o.');
                return;
            }
            
            if (targetROI < 2) {
                alert('‚ö†Ô∏è ROI muito baixo!\n\nO ROI m√≠nimo aceit√°vel √© 2x.\n\nROI inferior a 2x indica opera√ß√£o insustent√°vel e alto risco de churn imediato.');
                return;
            }
            
            const defaultRates = {
                delivery: 95,
                response: 20,
                cpc: 56,
                conversion: 23,
                payment: 40
            };
            
            let deliveryRate = parseFloat(document.getElementById('deliveryRate').value);
            let responseRate = parseFloat(document.getElementById('responseRate').value);
            let cpcRate = parseFloat(document.getElementById('cpcRate').value);
            let conversionRate = parseFloat(document.getElementById('conversionRate').value);
            let paymentRate = parseFloat(document.getElementById('paymentRate').value);
            let avgTicket = parseFloat(document.getElementById('avgTicket').value);
            
            let autoCalculated = {
                delivery: false,
                response: false,
                cpc: false,
                conversion: false,
                payment: false,
                ticket: false
            };
            
            if (isNaN(deliveryRate) || deliveryRate <= 0) {
                deliveryRate = defaultRates.delivery;
                document.getElementById('deliveryRate').value = deliveryRate;
                autoCalculated.delivery = true;
            }
            deliveryRate = deliveryRate / 100;
            
            if (isNaN(responseRate) || responseRate <= 0) {
                responseRate = defaultRates.response;
                document.getElementById('responseRate').value = responseRate;
                autoCalculated.response = true;
            }
            responseRate = responseRate / 100;
            
            if (isNaN(cpcRate) || cpcRate <= 0) {
                cpcRate = defaultRates.cpc;
                document.getElementById('cpcRate').value = cpcRate;
                autoCalculated.cpc = true;
            }
            cpcRate = cpcRate / 100;
            
            if (isNaN(conversionRate) || conversionRate <= 0) {
                conversionRate = defaultRates.conversion;
                document.getElementById('conversionRate').value = conversionRate;
                autoCalculated.conversion = true;
            }
            conversionRate = conversionRate / 100;
            
            if (isNaN(paymentRate) || paymentRate <= 0) {
                paymentRate = defaultRates.payment;
                document.getElementById('paymentRate').value = paymentRate;
                autoCalculated.payment = true;
            }
            paymentRate = paymentRate / 100;
            
            const workDays = parseFloat(document.getElementById('workDays').value);
            const paymentDeadline = parseFloat(document.getElementById('paymentDeadline').value);
            
            let adjustedMinAttendance = minAttendance;
            let hasLicense2985 = Math.abs(platformLicense - 2985) < 0.01;
            
            if (hasLicense2985) {
                adjustedMinAttendance = minAttendance + 1500;
            }
            
            function calculateInvestment(attendances) {
                if (hasLicense2985) {
                    return 2985 + ((attendances - 1500) * valuePerAttendance);
                } else {
                    return (valuePerAttendance * attendances) + platformLicense;
                }
            }
            
            const totalInvestmentMin = calculateInvestment(adjustedMinAttendance);
            const deliveredDispatchesMin = Math.ceil(adjustedMinAttendance / responseRate);
            const hsmCostMin = deliveredDispatchesMin * 0.05;
            const totalCostMin = totalInvestmentMin + hsmCostMin;
            
            let ticketAutoCalculated = false;
            if (isNaN(avgTicket) || avgTicket <= 0) {
                const totalDispatchesMin = Math.ceil(deliveredDispatchesMin / deliveryRate);
                const attendancesMin = adjustedMinAttendance;
                const cpcConfirmedMin = Math.ceil(attendancesMin * cpcRate);
                const generatedAgreementsMin = Math.ceil(cpcConfirmedMin * conversionRate);
                const paidAgreementsMin = Math.ceil(generatedAgreementsMin * paymentRate);
                
                const targetRecoveryForROI = totalCostMin * (1 + targetROI);
                avgTicket = targetRecoveryForROI / paidAgreementsMin;
                
                document.getElementById('avgTicket').value = avgTicket.toFixed(2);
                ticketAutoCalculated = true;
                autoCalculated.ticket = true;
            }
            
            const totalDispatchesMin = Math.ceil(deliveredDispatchesMin / deliveryRate);
            const attendancesMin = adjustedMinAttendance;
            const cpcConfirmedMin = Math.ceil(attendancesMin * cpcRate);
            const generatedAgreementsMin = Math.ceil(cpcConfirmedMin * conversionRate);
            const paidAgreementsMin = Math.ceil(generatedAgreementsMin * paymentRate);
            const targetRecoveryMin = paidAgreementsMin * avgTicket;
            
            const effectiveROIMin = (targetRecoveryMin - totalCostMin) / totalCostMin;
            
            const totalDispatches = totalDispatchesMin;
            const deliveredDispatches = deliveredDispatchesMin;
            const attendances = attendancesMin;
            const cpcConfirmed = cpcConfirmedMin;
            const generatedAgreements = generatedAgreementsMin;
            const paidAgreements = paidAgreementsMin;
            const targetRecovery = targetRecoveryMin;
            const totalInvestment = totalInvestmentMin;
            const hsmCost = hsmCostMin;
            const totalCost = totalCostMin;
            const effectiveROI = effectiveROIMin;
            
            const operationalCost = (totalCost / targetRecovery) * 100;
            
            const dailyDispatches = Math.ceil(totalDispatches / workDays);
            const penetrationFactor = totalDispatches / baseSize;
            const basePenetration = penetrationFactor * 100;
            const dispatchSpacing = Math.round(workDays / penetrationFactor);
            const productiveDays = workDays - paymentDeadline;
            const baseCapacity = Math.floor(baseSize * penetrationFactor);
            
            let scenarioHTML = '';
            
            let autoRatesMessage = '';
            const autoRatesList = [];
            if (autoCalculated.delivery) autoRatesList.push('Taxa de Entrega: ' + (deliveryRate * 100).toFixed(0) + '%');
            if (autoCalculated.response) autoRatesList.push('Taxa de Resposta: ' + (responseRate * 100).toFixed(0) + '%');
            if (autoCalculated.cpc) autoRatesList.push('Taxa de CPC: ' + (cpcRate * 100).toFixed(0) + '%');
            if (autoCalculated.conversion) autoRatesList.push('Taxa de Convers√£o: ' + (conversionRate * 100).toFixed(0) + '%');
            if (autoCalculated.payment) autoRatesList.push('Efetividade de Pagamento: ' + (paymentRate * 100).toFixed(0) + '%');
            
            if (autoRatesList.length > 0) {
                autoRatesMessage = `
                    <div style="background: #E3F2FD; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #2196F3;">
                        <h4 style="color: #1565C0; margin-bottom: 10px;">üìä Taxas Recomendadas Aplicadas</h4>
                        <p style="color: #555; margin-bottom: 10px;">
                            Os seguintes campos foram preenchidos automaticamente com taxas recomendadas baseadas em hist√≥rico de opera√ß√µes:
                        </p>
                        <ul style="color: #555; margin-left: 20px;">
                            ${autoRatesList.map(rate => '<li>' + rate + '</li>').join('')}
                        </ul>
                        <p style="color: #555; margin-top: 10px; font-size: 0.95em;">
                            <strong>üí° Dica:</strong> Voc√™ pode ajustar estes valores a qualquer momento com base nos dados reais da sua opera√ß√£o.
                        </p>
                    </div>
                `;
            }
            
            let ticketAdjustmentHTML = '';
            const recommendedTicket = (totalCost * (1 + targetROI)) / paidAgreements;
            
            if (effectiveROI < targetROI) {
                const ticketIncrease = ((recommendedTicket - avgTicket) / avgTicket) * 100;
                ticketAdjustmentHTML = `
                    <div style="background: #FFF3E0; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 5px solid #FF9800;">
                        <h4 style="color: #E65100; margin-bottom: 15px;">üí° Oportunidade: Otimiza√ß√£o de ROI</h4>
                        <p style="margin-bottom: 15px; color: #555;">
                            O c√°lculo foi baseado no <strong>m√≠nimo garantido de ${formatNumber(minAttendance)} atendimentos</strong> (prioridade #1).
                            Para atingir tamb√©m o <strong>ROI objetivo de ${targetROI}x</strong>, seria necess√°rio um ticket m√©dio maior.
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div style="background: #FFFFFF; padding: 15px; border-radius: 8px; border: 2px solid #FF9800;">
                                <div style="color: #E65100; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;">Ticket Atual</div>
                                <div style="color: #FF6F00; font-weight: 700; font-size: 1.3em;">${formatCurrency(avgTicket)}</div>
                            </div>
                            <div style="background: #FFFFFF; padding: 15px; border-radius: 8px; border: 2px solid #4CAF50;">
                                <div style="color: #2E7D32; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;">Ticket Ideal para ROI ${targetROI}x</div>
                                <div style="color: #1B5E20; font-weight: 700; font-size: 1.3em;">${formatCurrency(recommendedTicket)}</div>
                            </div>
                            <div style="background: #FFFFFF; padding: 15px; border-radius: 8px; border: 2px solid #13AAE6;">
                                <div style="color: #0277BD; font-weight: 600; font-size: 0.9em; margin-bottom: 8px;">Aumento Necess√°rio</div>
                                <div style="color: #01579B; font-weight: 700; font-size: 1.3em;">+${ticketIncrease.toFixed(1)}%</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #555; font-size: 0.95em;">
                            <strong>A√ß√µes para aumentar ticket m√©dio:</strong><br>
                            ‚Ä¢ Trabalhar com ofertas de valores maiores<br>
                            ‚Ä¢ Focar em devedores com d√©bitos de maior valor<br>
                            ‚Ä¢ Ajustar estrat√©gia de negocia√ß√£o<br>
                            ‚Ä¢ Priorizar carteira de alto valor
                        </p>
                    </div>
                `;
            }
            
            let autoTicketMessage = '';
            if (ticketAutoCalculated) {
                autoTicketMessage = `
                    <div style="background: #E8F5E9; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid #4CAF50;">
                        <p style="color: #2E7D32; font-weight: 600;">
                            ‚úÖ <strong>Ticket M√©dio Calculado Automaticamente:</strong> ${formatCurrency(avgTicket)}
                        </p>
                        <p style="color: #555; margin-top: 8px; font-size: 0.95em;">
                            Este valor foi calculado para atingir o ROI de ${targetROI}x com ${formatNumber(attendances)} atendimentos${hasLicense2985 ? ' (incluindo 1.500 de car√™ncia)' : ''}.
                        </p>
                    </div>
                `;
            }
            
            let license2985Message = '';
            if (hasLicense2985) {
                license2985Message = `
                    <div style="background: #E3F2FD; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 5px solid #2196F3;">
                        <h4 style="color: #1565C0; margin-bottom: 10px;">üìã Plano Licen√ßa R$ 2.985,00 Detectado</h4>
                        <p style="color: #555; margin-bottom: 10px;">
                            <strong>M√≠nimo Garantido Contratado:</strong> ${formatNumber(minAttendance)} atendimentos<br>
                            <strong>Car√™ncia Inclusa no Plano:</strong> 1.500 atendimentos<br>
                            <strong>Total de Atendimentos a Gerar:</strong> ${formatNumber(adjustedMinAttendance)} atendimentos
                        </p>
                        <p style="color: #555; font-size: 0.95em;">
                            üí° O c√°lculo considera automaticamente os 1.500 atendimentos de car√™ncia inclusos no valor do plano.
                        </p>
                    </div>
                `;
            }
            
            scenarioHTML = `
                ${license2985Message}
                ${autoRatesMessage}
                ${autoTicketMessage}
                <div class="success-box">
                    ‚úÖ <strong>C√°lculo Baseado no M√≠nimo Garantido</strong><br><br>
                    O funil foi estruturado priorizando o volume de <strong>${formatNumber(attendances)} atendimentos</strong>${hasLicense2985 ? ' (m√≠nimo garantido + car√™ncia)' : ''} conforme contratado.
                    ${effectiveROI >= targetROI ? `<br>ROI objetivo de ${targetROI}x foi atingido com sucesso!` : ''}
                </div>
                ${ticketAdjustmentHTML}
            `;
            document.getElementById('scenarioAnalysis').innerHTML = scenarioHTML;
            
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
            document.getElementById('hsmCost').textContent = formatCurrency(hsmCost);
            document.getElementById('finalInvestment').textContent = formatCurrency(totalCost);
            document.getElementById('targetRecovery').textContent = formatCurrency(targetRecovery);
            document.getElementById('roiDisplay').textContent = formatROI(effectiveROI);
            document.getElementById('operationalCost').textContent = operationalCost.toFixed(1) + '%';
            
            const funnelData = [
                { step: '1', name: 'Disparos Agendados', value: totalDispatches, calc: 'Total do m√™s' },
                { step: '‚Üì', name: 'Taxa de Entrega', value: formatPercent(deliveryRate * 100), calc: '-' },
                { step: '2', name: 'Disparos Entregues', value: deliveredDispatches, calc: totalDispatches + ' √ó ' + formatPercent(deliveryRate * 100) },
                { step: '‚Üì', name: 'Taxa de Resposta', value: formatPercent(responseRate * 100), calc: '-' },
                { step: '3', name: 'Atendimentos', value: attendances, calc: deliveredDispatches + ' √ó ' + formatPercent(responseRate * 100) },
                { step: '‚Üì', name: 'Taxa de CPC', value: formatPercent(cpcRate * 100), calc: '-' },
                { step: '4', name: 'Identidade Confirmada', value: cpcConfirmed, calc: attendances + ' √ó ' + formatPercent(cpcRate * 100) },
                { step: '‚Üì', name: 'Taxa de Convers√£o', value: formatPercent(conversionRate * 100), calc: '-' },
                { step: '5', name: 'Acordos Gerados', value: generatedAgreements, calc: cpcConfirmed + ' √ó ' + formatPercent(conversionRate * 100) },
                { step: '‚Üì', name: 'Efetividade de Pagamento', value: formatPercent(paymentRate * 100), calc: '-' },
                { step: '6', name: 'Acordos Pagos', value: paidAgreements, calc: generatedAgreements + ' √ó ' + formatPercent(paymentRate * 100), highlight: true },
                { step: '=', name: 'Valor Recuperado', value: formatCurrency(targetRecovery), calc: paidAgreements + ' √ó ' + formatCurrency(avgTicket), highlight: true }
            ];
            
            let tableHTML = '';
            funnelData.forEach(row => {
                const rowClass = row.highlight ? 'highlight-row' : '';
                const stepDisplay = row.step.match(/\d+/) ? `<span class="step-number">${row.step}</span>` : row.step;
                const valueDisplay = typeof row.value === 'number' ? formatNumber(row.value) : row.value;
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${stepDisplay}</td>
                        <td class="metric-name">${row.name}</td>
                        <td class="metric-value">${valueDisplay}</td>
                        <td>${row.calc}</td>
                    </tr>
                `;
            });
            
            document.getElementById('funnelTableBody').innerHTML = tableHTML;
            
            document.getElementById('dailyDispatches').textContent = formatNumber(dailyDispatches);
            document.getElementById('dispatchSpacing').textContent = dispatchSpacing + ' dias';
            document.getElementById('basePenetration').textContent = basePenetration.toFixed(1) + '%';
            document.getElementById('productiveDays').textContent = productiveDays + ' D.U.';
            document.getElementById('baseCapacity').textContent = formatNumber(baseCapacity) + ' disparos';
            
            let alerts = '';
            
            if (hasLicense2985) {
                alerts += `<div style="background: #E8F5E9; border-left: 5px solid #4CAF50; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <strong style="color: #2E7D32;">‚úÖ Plano Licen√ßa R$ 2.985,00</strong><br><br>
                    <span style="color: #555;">
                        <strong>F√≥rmula de investimento aplicada:</strong><br>
                        R$ 2.985,00 + ((${formatNumber(adjustedMinAttendance)} - 1.500) √ó ${formatCurrency(valuePerAttendance)})<br><br>
                        <strong>Atendimentos considerados:</strong><br>
                        ‚Ä¢ Contratados: ${formatNumber(minAttendance)}<br>
                        ‚Ä¢ Car√™ncia: 1.500<br>
                        ‚Ä¢ Total a gerar: ${formatNumber(adjustedMinAttendance)}
                    </span>
                </div>`;
            }
            
            if (effectiveROI < 10) {
                const targetRoiPercentage = (targetROI * 100).toFixed(0);
                const roiGap = (targetROI - effectiveROI) * 100;
                
                alerts += `<div class="warning-box" style="background: #FFF3E0; border-left-color: #F57C00;">
                    <strong style="color: #E65100;">‚ö†Ô∏è ATEN√á√ÉO: ROI Abaixo de 10x</strong><br><br>
                    <span style="color: #555;">
                        <strong>ROI Calculado:</strong> ${formatROI(effectiveROI)}<br>
                        <strong>ROI Objetivo:</strong> ${targetRoiPercentage}% (${targetROI}x)<br>
                        <strong>Gap:</strong> ${roiGap.toFixed(1)} pontos percentuais<br><br>
                        <strong>Situa√ß√£o:</strong> O funil foi calculado priorizando o <strong>m√≠nimo de ${formatNumber(attendances)} atendimentos</strong>, 
                        resultando em um ROI abaixo do ideal de 10x (1000%).<br><br>
                        <strong>Impacto:</strong><br>
                        ‚Ä¢ Rentabilidade reduzida da opera√ß√£o<br>
                        ‚Ä¢ Margem de lucro comprometida<br>
                        ‚Ä¢ Poss√≠vel insatisfa√ß√£o do cliente com resultados<br><br>
                        <strong>Recomenda√ß√µes para aumentar ROI:</strong><br>
                        ‚Ä¢ <strong>Aumentar ticket m√©dio</strong> atrav√©s de melhores ofertas de negocia√ß√£o<br>
                        ‚Ä¢ <strong>Otimizar taxas de convers√£o</strong> do funil (CPC, convers√£o, pagamento)<br>
                        ‚Ä¢ <strong>Melhorar qualidade da base</strong> para reduzir custo por atendimento<br>
                        ‚Ä¢ <strong>Reduzir custos operacionais</strong> otimizando disparos<br>
                        ‚Ä¢ <strong>Revisar pricing</strong> com o cliente se necess√°rio
                    </span>
                </div>`;
            }
            
            if (operationalCost > 10) {
                const excessCost = operationalCost - 7;
                alerts += `<div class="warning-box" style="background: #FFF3E0; border-left-color: #FF9800;">
                    <strong style="color: #E65100;">‚ö†Ô∏è ATEN√á√ÉO: Custo Operacional Elevado</strong><br><br>
                    <span style="color: #555;">
                        <strong>Custo Operacional Atual:</strong> ${operationalCost.toFixed(1)}%<br>
                        <strong>Custo Operacional Saud√°vel:</strong> Abaixo de 7%<br>
                        <strong>Diferen√ßa:</strong> +${excessCost.toFixed(1)} pontos percentuais acima do ideal<br><br>
                        <strong>Impacto:</strong><br>
                        ‚Ä¢ Margem de lucro reduzida<br>
                        ‚Ä¢ Opera√ß√£o menos eficiente<br>
                        ‚Ä¢ ROI comprometido<br>
                        ‚Ä¢ Sustentabilidade financeira em risco<br><br>
                        <strong>Recomenda√ß√µes para reduzir custo operacional:</strong><br>
                        ‚Ä¢ <strong>Otimizar taxas de convers√£o</strong> do funil (reduz custo por acordo)<br>
                        ‚Ä¢ <strong>Aumentar ticket m√©dio</strong> dos acordos (aumenta receita)<br>
                        ‚Ä¢ <strong>Melhorar taxa de resposta</strong> (reduz disparos necess√°rios)<br>
                        ‚Ä¢ <strong>Aumentar efetividade de pagamento</strong> (mais acordos pagos)<br>
                        ‚Ä¢ <strong>Revisar pricing</strong> com o cliente para melhorar margens<br>
                        ‚Ä¢ <strong>Reduzir custo HSM</strong> otimizando quantidade de disparos
                    </span>
                </div>`;
            }
            
            if (hasLicense2985 && adjustedMinAttendance < 11500) {
                alerts += `<div class="warning-box" style="background: #FFF3E0; border-left-color: #FF9800;">
                    <strong style="color: #E65100;">‚ö†Ô∏è ATEN√á√ÉO: Volume Abaixo do Ideal para Licen√ßa R$ 2.985,00</strong><br><br>
                    <span style="color: #555;">
                        <strong>M√≠nimo Garantido Contratado:</strong> ${formatNumber(minAttendance)}<br>
                        <strong>Total com Car√™ncia:</strong> ${formatNumber(adjustedMinAttendance)} atendimentos<br>
                        <strong>Volume Ideal para este Plano:</strong> 11.500 atendimentos (10.000 contratados + 1.500 car√™ncia)<br><br>
                        <strong>D√©ficit:</strong> ${formatNumber(11500 - adjustedMinAttendance)} atendimentos (${((11500 - adjustedMinAttendance) / 11500 * 100).toFixed(1)}%)<br><br>
                        <strong>Recomenda√ß√£o:</strong> Para otimizar o investimento no plano de R$ 2.985,00, considere contratar no m√≠nimo 10.000 atendimentos (resultando em 11.500 com a car√™ncia inclusa).
                    </span>
                </div>`;
            }
            
            if (basePenetration > 400) {
                alerts += `<div class="warning-box" style="background: #FFEBEE; border-left-color: #D32F2F;">
                    <strong style="color: #C62828;">üö® ALERTA CR√çTICO: Satura√ß√£o Extrema da Base</strong><br><br>
                    <span style="color: #555;">
                        <strong>Penetra√ß√£o de base:</strong> ${basePenetration.toFixed(1)}% (limite cr√≠tico: 400%)<br><br>
                        A estrat√©gia de disparos poder√° <strong>prejudicar severamente a opera√ß√£o do cliente</strong>, pois estar√° saturando muito a base.
                    </span>
                </div>`;
            }
            
            if (dispatchSpacing < 7) {
                alerts += `<div class="warning-box" style="background: #FFF3E0; border-left-color: #F57C00;">
                    <strong style="color: #E65100;">‚ö†Ô∏è ALERTA DE ALTO RISCO: Espa√ßamento Insuficiente</strong><br><br>
                    <span style="color: #555;">
                        <strong>Espa√ßamento entre disparos:</strong> ${dispatchSpacing} dias (m√≠nimo recomendado: 7 dias)<br><br>
                        Alto risco de problemas na opera√ß√£o devido √† penetra√ß√£o da base muito intensa.
                    </span>
                </div>`;
            }
            
            if (targetROI < 7) {
                alerts += `<div class="warning-box" style="background: #FFEBEE; border-left-color: #D32F2F;">
                    <strong style="color: #C62828;">üö® ALERTA CR√çTICO: Risco √† Sa√∫de Financeira da Opera√ß√£o</strong><br><br>
                    <span style="color: #555;">
                        <strong>ROI configurado:</strong> ${targetROI}x (abaixo do m√≠nimo recomendado de 7x)<br><br>
                        ROI extremamente baixo indica opera√ß√£o de alto risco com sustentabilidade question√°vel.
                    </span>
                </div>`;
            } else if (targetROI >= 7 && targetROI < 15) {
                alerts += `<div class="warning-box" style="background: #FFF3E0; border-left-color: #FF9800;">
                    <strong style="color: #E65100;">‚ö†Ô∏è ATEN√á√ÉO: ROI Abaixo do Recomendado</strong><br><br>
                    <span style="color: #555;">
                        <strong>ROI configurado:</strong> ${targetROI}x (recomendado: 15x)<br><br>
                        Considere otimizar as taxas de convers√£o e aumentar o ticket m√©dio para melhorar o ROI.
                    </span>
                </div>`;
            }
            
            if (basePenetration > 200 && basePenetration <= 400) {
                alerts += `<div class="warning-box">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> A penetra√ß√£o de base √© alta (${basePenetration.toFixed(1)}%). 
                    Considere aumentar a base ou revisar as metas.
                </div>`;
            }
            
            document.getElementById('alertMessages').innerHTML = alerts;
            
            document.getElementById('results').classList.add('active');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function downloadPDF() {
            alert('Funcionalidade de PDF ser√° implementada em breve.');
        }
    </script>
</body>
</html>
